<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>2D Pen / Laser / CNC G-Code Generator</title>
  <style>
    :root{--gap:12px;--muted:#666}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:18px;color:#111}
    h1{font-size:1.2rem;margin:0 0 8px}
    .controls{display:flex;flex-wrap:wrap;gap:var(--gap);margin:10px 0 18px}
    .control{display:flex;flex-direction:column;min-width:180px}
    label{font-size:0.85rem;margin-bottom:6px}
    input[type=file]{padding:6px}
    input, select, button, textarea{font:inherit}
    canvas{border:1px solid #d0d0d0;max-width:100%;height:auto;background:#fff}
    .row{display:flex;gap:var(--gap);align-items:flex-start}
    .col{flex:1;min-width:280px}
    .col.small{flex:0 0 360px}
    button{padding:8px 12px;border-radius:6px;border:1px solid #888;background:#f6f6f6;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .footer{margin-top:14px;font-size:0.9rem;color:var(--muted)}
    textarea{width:100%;height:300px;resize:vertical;font-family:monospace;padding:10px;border:1px solid #ddd}
    .meta{font-size:0.85rem;color:var(--muted);margin-top:6px}
    .controls .control.actions{align-items:flex-start;justify-content:flex-end}
    .help{font-size:0.9rem;color:#333;margin-bottom:6px}
    .toggles{display:flex;gap:12px;align-items:center}
  </style>
</head>
<body>
  <h1>2D Pen / Laser / CNC G-Code Generator (Raster Engrave)</h1>

  <div class="controls" role="region" aria-label="Controls">
    <div class="control">
      <label for="file">Upload image</label>
      <input id="file" type="file" accept="image/*" aria-label="Upload image" />
      <div class="meta">Tip: use simple high-contrast PNG/JPG for best results.</div>
    </div>

    <div class="control">
      <label for="mmPerPixel">Scale — mm per pixel</label>
      <input id="mmPerPixel" type="number" step="0.01" value="0.25" />
    </div>

    <div class="control">
      <label for="lineSpacing">Line spacing (pixels)</label>
      <input id="lineSpacing" type="number" step="1" value="2" min="1" />
    </div>

    <div class="control">
      <label for="threshold">Dark threshold (0–255)</label>
      <input id="threshold" type="number" step="1" value="128" min="0" max="255" />
    </div>

    <div class="control">
      <label for="feedrate">Feedrate (mm/min)</label>
      <input id="feedrate" type="number" step="1" value="1200" />
    </div>

    <div class="control">
      <label for="mode">Output mode</label>
      <select id="mode">
        <option value="laser">Laser (M3/M5)</option>
        <option value="pen">Pen (commented PEN_DOWN/PEN_UP)</option>
      </select>
    </div>

    <div class="control">
      <label>Coordinate transforms</label>
      <div class="toggles">
        <label><input id="flipX" type="checkbox" /> Flip horizontal</label>
        <label><input id="flipY" type="checkbox" /> Flip vertical (invert Y)</label>
      </div>
      <div class="meta">If output looks mirrored relative to the image, try flipping vertical (most common).</div>
    </div>

    <div class="control actions">
      <label>&nbsp;</label>
      <div style="display:flex;gap:8px;">
        <button id="generate">Generate G-Code</button>
        <button id="download" disabled>Download G-Code</button>
      </div>
      <div style="margin-top:6px;font-size:0.85rem;color:var(--muted)">G-Code appears in the right-hand box after generation.</div>
    </div>
  </div>

  <div class="row" style="align-items:flex-start;">
    <div class="col">
      <div class="help">Original image (display-size)</div>
      <canvas id="origCanvas" width="600" height="400" aria-label="Original image preview"></canvas>
      <div style="height:10px"></div>
      <div class="help">Simulated output preview</div>
      <canvas id="previewCanvas" width="600" height="400" aria-label="Simulated output preview"></canvas>
    </div>

    <div class="col small">
      <div class="help">Generated G-Code</div>
      <textarea id="gcodeText" placeholder="G-Code will appear here..." aria-label="Generated G-Code" readonly></textarea>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button id="copy" disabled>Copy G-Code</button>
        <button id="clear">Clear</button>
      </div>
      <div class="meta" id="info">No image loaded</div>
    </div>
  </div>

  <div class="footer">
    <p>This generator creates a simple raster-scan engraving G-Code. It scans horizontal rows and issues motion commands with the tool on for dark pixel runs. Output uses millimetres (G21) and absolute coords (G90). For real machines, review and adapt header/footer and any machine-specific M-codes.</p>
  </div>

  <script>
    const fileEl = document.getElementById('file')
    const origCanvas = document.getElementById('origCanvas')
    const previewCanvas = document.getElementById('previewCanvas')
    const generateBtn = document.getElementById('generate')
    const downloadBtn = document.getElementById('download')
    const gcodeText = document.getElementById('gcodeText')
    const copyBtn = document.getElementById('copy')
    const clearBtn = document.getElementById('clear')
    const info = document.getElementById('info')
    const flipXEl = document.getElementById('flipX')
    const flipYEl = document.getElementById('flipY')

    let fullImage = null
    let latestGcode = ''

    fileEl.addEventListener('change', handleFile)
    generateBtn.addEventListener('click', generateGcode)
    downloadBtn.addEventListener('click', downloadGcode)
    copyBtn.addEventListener('click', ()=>{ navigator.clipboard?.writeText(latestGcode).then(()=>alert('Copied to clipboard')) })
    clearBtn.addEventListener('click', clearAll)

    function handleFile(e){
      const f = e.target.files && e.target.files[0]
      if(!f) return
      const img = new Image()
      img.onload = () => {
        const maxDisplay = 800
        let w = img.width, h = img.height
        const scale = Math.min(1, maxDisplay / Math.max(w,h))
        origCanvas.width = Math.round(w * scale)
        origCanvas.height = Math.round(h * scale)
        previewCanvas.width = origCanvas.width
        previewCanvas.height = origCanvas.height

        const ctx = origCanvas.getContext('2d')
        ctx.clearRect(0,0,origCanvas.width,origCanvas.height)
        ctx.drawImage(img,0,0,origCanvas.width,origCanvas.height)

        fullImage = img
        latestGcode = ''
        gcodeText.value = ''
        downloadBtn.disabled = true
        copyBtn.disabled = true
        info.textContent = `Image loaded — ${img.width}×${img.height}px`
      }
      img.onerror = () => alert('Failed to load image')
      img.src = URL.createObjectURL(f)
    }

    function generateGcode(){
      if(!fullImage){ alert('Please upload an image first'); return }

      const mmPerPixel = parseFloat(document.getElementById('mmPerPixel').value) || 0.25
      const lineSpacing = Math.max(1, parseInt(document.getElementById('lineSpacing').value) || 2)
      const threshold = Math.min(255, Math.max(0, parseInt(document.getElementById('threshold').value)||128))
      const feedrate = parseInt(document.getElementById('feedrate').value) || 1200
      const mode = document.getElementById('mode').value
      const flipX = flipXEl.checked
      const flipY = flipYEl.checked

      const off = document.createElement('canvas')
      off.width = fullImage.width
      off.height = fullImage.height
      const ctx = off.getContext('2d')
      ctx.drawImage(fullImage, 0, 0)
      const imgData = ctx.getImageData(0,0,off.width,off.height).data

      const displayW = origCanvas.width
      const displayH = origCanvas.height
      const scaleX = displayW / off.width
      const scaleY = displayH / off.height
      const pctx = previewCanvas.getContext('2d')
      pctx.clearRect(0,0,previewCanvas.width,previewCanvas.height)
      pctx.fillStyle = '#fff'
      pctx.fillRect(0,0,previewCanvas.width,previewCanvas.height)
      pctx.strokeStyle = '#000'
      pctx.lineWidth = Math.max(1, 1*scaleX)

      let lines = []
      lines.push('; Generated by BonusHW2 G-Code generator')
      lines.push('G21 ; units = mm')
      lines.push('G90 ; absolute positioning')
      lines.push('G0 F' + feedrate)

      // Raster scan rows
      for(let row=0; row<off.height; row += lineSpacing){
        // compute Y taking flipY into account: row is 0..off.height-1 (top->down)
        const emitRow = flipY ? (off.height - 1 - row) : row
        const y_mm = emitRow * mmPerPixel

        // build dark array for this original row (we always evaluate source pixels in image top->down order)
        let dark = new Array(off.width)
        for(let x=0;x<off.width;x++){
          const idx = (row*off.width + x) * 4
          const r = imgData[idx], g = imgData[idx+1], b = imgData[idx+2]
          const lum = 0.299*r + 0.587*g + 0.114*b
          dark[x] = lum < threshold
        }

        // choose traversal direction (zigzag) as before
        const zig = Math.floor(row / lineSpacing) % 2 === 1
        let x = zig ? off.width - 1 : 0
        const step = zig ? -1 : 1

        while(x >= 0 && x < off.width){
          if(!dark[x]){ x += step; continue }
          let start = x
          while(x >= 0 && x < off.width && dark[x]) x += step
          let end = x - step // last dark pixel in traversal order

          // apply flipX mapping for emitted X coordinates and preview coordinates
          const emitStart = flipX ? (off.width - 1 - start) : start
          const emitEnd   = flipX ? (off.width - 1 - end)   : end

          const xStart_mm = emitStart * mmPerPixel
          const xEnd_mm   = emitEnd * mmPerPixel

          // Move to start (rapid)
          lines.push('G0 X' + xStart_mm.toFixed(3) + ' Y' + y_mm.toFixed(3))
          if(mode === 'laser') lines.push('M3 ; laser ON')
          else lines.push(';PEN_DOWN')
          // Engrave/mark move (G1) start -> end
          lines.push('G1 X' + xEnd_mm.toFixed(3) + ' Y' + y_mm.toFixed(3) + ' F' + feedrate)
          if(mode === 'laser') lines.push('M5 ; laser OFF')
          else lines.push(';PEN_UP')

          // Preview drawing: use emitted coordinates mapped to display pixels
          const drawStart = Math.min(emitStart, emitEnd)
          const drawEnd   = Math.max(emitStart, emitEnd)
          // compute preview Y (row coord in display pixels)
          const previewRow = flipY ? (off.height - 1 - row) : row
          pctx.beginPath()
          pctx.moveTo(drawStart*scaleX + 0.5, previewRow*scaleY + 0.5)
          pctx.lineTo(drawEnd*scaleX + 0.5, previewRow*scaleY + 0.5)
          pctx.stroke()
        }
      }

      lines.push('; End program')

      latestGcode = lines.join('\n')
      gcodeText.value = latestGcode
      downloadBtn.disabled = false
      copyBtn.disabled = false
      info.textContent = `G-code generated — ${lines.length} lines — preview shown (FlipX=${flipX}, FlipY=${flipY})`
      gcodeText.focus()
    }

    function downloadGcode(){
      if(!latestGcode) return
      const blob = new Blob([latestGcode], {type:'text/plain'})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = 'engrave_' + (new Date()).toISOString().replace(/[:.]/g,'-') + '.gcode'
      document.body.appendChild(a)
      a.click()
      a.remove()
      URL.revokeObjectURL(url)
    }

    function clearAll(){
      origCanvas.getContext('2d').clearRect(0,0,origCanvas.width,origCanvas.height)
      previewCanvas.getContext('2d').clearRect(0,0,previewCanvas.width,previewCanvas.height)
      fileEl.value = ''
      fullImage = null
      latestGcode = ''
      gcodeText.value = ''
      downloadBtn.disabled = true
      copyBtn.disabled = true
      info.textContent = 'Cleared'
    }
  </script>
</body>
</html>
